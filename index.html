<!DOCTYPE html>
<meta charset="utf-8">
<head>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">
  <style>

body {
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
}

.box {
  font: 10px sans-serif;
}

.box line,
.box rect,
.box circle {
  fill: #fff;
  stroke: #000;
  stroke-width: 1.5px;
}

.box .center {
  stroke-dasharray: 3,3;
}

.box .outlier {
  fill: none;
  stroke: #ccc;
}

  </style>
</head>
<body>
  <div class="container">
  <h1>A chemical analysis of Wine Quality</h1>
  <p>
  This dataset is related to red variants of the Portuguese "Vinho Verde" wine
  For more details, consult: http://www.vinhoverde.pt/en/ or the reference [Cortez et al., 2009].
  There are 1599 observation of wines in the dataset with 12 features . There is one categorical variable (quality) and the others are numerical variables that indicate wine physical and chemical properties of the wine.
  </p>
  <p>
  The median quality is 6, which in the given scale (1-10) is a mediocre wine. The better wine in the sample has a score of 8, and the worst has a score of 3. The dataset is not balanced, that is, there are a more average wines than poor or excelent ones.
  </p>
  <p>
  The most revealing correlation found was quality vs alcohol. With an increase in alcohol graduation we see an increase in the concentration of better graded wines. Given the high number of outliers we cannot rely on alcohol alone to produce better wines but next time you're at the supermarket it might be a good idead to look for stronger wines.
  </p>
  <p>
  Finnaly, this visualization allows you to explore other variables and their relations with quality.
  </p>
  <form>
    <div class="form-group">
      <label >Variable</label>
      <select id="variables-select"></select>
    </div>
  </form>
  <div id="chart"></div>
  </div>
  <script src="//d3js.org/d3.v3.min.js"></script>
  <script src="js/box.js"></script>
  <script>

  var margin = {top: 10, right: 50, bottom: 20, left: 50},
    width = 120 - margin.left - margin.right,
    height = 500 - margin.top - margin.bottom;

  var chart = d3.box()
    .whiskers(iqr(1.5))
    .width(width)
    .height(height);

  d3.csv("data/wineQualityReds.csv", function(error, csv) {
    if (error) throw error;
    d3.csv("data/variables.csv", function(error, variables) {
      if (error) throw error;

      var r = filterCSV(csv, "alcohol");
      var data = r[0];
      var extent = r[1];

      chart.domain(extent);

      var svg = d3.select("div#chart").selectAll("svg")
        .data(data)
        .enter().append("svg")
        .attr("class", "box")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.bottom + margin.top)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
        .call(chart);

      function changeVariable() {
        var key = this.children[this.selectedIndex].value
          var r = filterCSV(csv, key);
        var data = r[0];
        var extent = r[1];
        svg.datum(function(d,i) {
          return data[i];
        })
        chart.domain(extent);
        svg.call(chart.duration(1000))
      };


      var select  = d3.select("select#variables-select")
        .on("change", changeVariable);

      var options = select
        .selectAll('option')
        .data(variables);

      options
        .enter()
        .append("option")
        .text(function(d) { return d.name; })
        .attr("value", function(d) { return d.variable ;});

    });
  });


function filterCSV(csv, key) {

  var data = d3.nest()
    .key(function(d) {return d.quality;})
    .rollup(function(leaves) {
      return leaves.map(function(d) {return +d[key]})
    })
  .entries(csv);

  data = data.map(function(d) { return d.values })

    var extent = d3.extent(csv.map(function(d) {return +d[key]}));
  return [data, extent]
}

// Returns a function to compute the interquartile range.
function iqr(k) {
  return function(d, i) {
    var q1 = d.quartiles[0],
    q3 = d.quartiles[2],
    iqr = (q3 - q1) * k,
    i = -1,
    j = d.length;
    while (d[++i] < q1 - iqr);
    while (d[--j] > q3 + iqr);
    return [i, j];
  };
}

  </script>
</body>
